{{- $city := .Get "city" -}}
{{- $lat := .Get "lat" -}}
{{- $lng := .Get "lng" -}}
{{- $widgetId := .Get "id" | default "weather-widget" -}}

<div id="{{ $widgetId }}" class="weather-widget" data-city="{{ $city }}" data-lat="{{ $lat }}" data-lng="{{ $lng }}">
  <div class="weather-header">
    <h3>7-Day Weather Forecast for {{ $city }}</h3>
    <div class="weather-loading">Loading weather data...</div>
  </div>
  <div class="weather-forecast" style="display: none;">
    <div class="forecast-days"></div>
  </div>
  <div class="weather-error" style="display: none;">
    <p>Weather data temporarily unavailable. Please check back later.</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const widget = document.getElementById('{{ $widgetId }}');
  const city = widget.dataset.city;
  const lat = parseFloat(widget.dataset.lat);
  const lng = parseFloat(widget.dataset.lng);
  
  // OpenWeatherMap API (requires free API key)
  // Note: You'll need to sign up at openweathermap.org and add your API key
  const API_KEY = 'YOUR_OPENWEATHER_API_KEY'; // Replace with actual API key
  
  if (API_KEY === 'YOUR_OPENWEATHER_API_KEY') {
    showWeatherDemo(widget, city);
    return;
  }
  
  fetchWeatherData(lat, lng, API_KEY)
    .then(data => displayWeather(widget, data))
    .catch(error => showWeatherError(widget));
});

async function fetchWeatherData(lat, lng, apiKey) {
  const response = await fetch(
    `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lng}&appid=${apiKey}&units=imperial`
  );
  
  if (!response.ok) {
    throw new Error('Weather API request failed');
  }
  
  return await response.json();
}

function displayWeather(widget, data) {
  const forecastContainer = widget.querySelector('.forecast-days');
  const loadingElement = widget.querySelector('.weather-loading');
  const forecastElement = widget.querySelector('.weather-forecast');
  
  // Group forecasts by day (API returns 3-hour intervals)
  const dailyForecasts = groupForecastsByDay(data.list);
  
  let html = '';
  dailyForecasts.slice(0, 7).forEach((day, index) => {
    const date = new Date(day.dt * 1000);
    const dayName = index === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
    const temp = Math.round(day.main.temp);
    const tempMin = Math.round(day.main.temp_min);
    const tempMax = Math.round(day.main.temp_max);
    const description = day.weather[0].description;
    const icon = getWeatherIcon(day.weather[0].main);
    
    html += `
      <div class="forecast-day">
        <div class="day-name">${dayName}</div>
        <div class="weather-icon">${icon}</div>
        <div class="temperature">
          <span class="temp-high">${tempMax}°</span>
          <span class="temp-low">${tempMin}°</span>
        </div>
        <div class="description">${description}</div>
      </div>
    `;
  });
  
  forecastContainer.innerHTML = html;
  loadingElement.style.display = 'none';
  forecastElement.style.display = 'block';
}

function groupForecastsByDay(forecasts) {
  const dailyData = {};
  
  forecasts.forEach(forecast => {
    const date = new Date(forecast.dt * 1000).toDateString();
    if (!dailyData[date]) {
      dailyData[date] = forecast;
    }
  });
  
  return Object.values(dailyData);
}

function getWeatherIcon(condition) {
  const icons = {
    'Clear': '☀️',
    'Clouds': '☁️',
    'Rain': '🌧️',
    'Drizzle': '🌦️',
    'Thunderstorm': '⛈️',
    'Snow': '❄️',
    'Mist': '🌫️',
    'Fog': '🌫️'
  };
  return icons[condition] || '🌤️';
}

function showWeatherError(widget) {
  widget.querySelector('.weather-loading').style.display = 'none';
  widget.querySelector('.weather-error').style.display = 'block';
}

function showWeatherDemo(widget, city) {
  // Demo data when API key is not configured
  const demoData = [
    { day: 'Today', icon: '☀️', high: 75, low: 58, desc: 'Sunny' },
    { day: 'Tue', icon: '⛅', high: 72, low: 55, desc: 'Partly cloudy' },
    { day: 'Wed', icon: '🌧️', high: 68, low: 52, desc: 'Light rain' },
    { day: 'Thu', icon: '☁️', high: 70, low: 54, desc: 'Cloudy' },
    { day: 'Fri', icon: '☀️', high: 76, low: 60, desc: 'Sunny' },
    { day: 'Sat', icon: '🌤️', high: 74, low: 57, desc: 'Mostly sunny' },
    { day: 'Sun', icon: '⛅', high: 71, low: 56, desc: 'Partly cloudy' }
  ];
  
  let html = '';
  demoData.forEach(day => {
    html += `
      <div class="forecast-day">
        <div class="day-name">${day.day}</div>
        <div class="weather-icon">${day.icon}</div>
        <div class="temperature">
          <span class="temp-high">${day.high}°</span>
          <span class="temp-low">${day.low}°</span>
        </div>
        <div class="description">${day.desc}</div>
      </div>
    `;
  });
  
  const forecastContainer = widget.querySelector('.forecast-days');
  const loadingElement = widget.querySelector('.weather-loading');
  const forecastElement = widget.querySelector('.weather-forecast');
  
  forecastContainer.innerHTML = html + '<div class="demo-notice">Demo data - Add your OpenWeatherMap API key for live weather</div>';
  loadingElement.style.display = 'none';
  forecastElement.style.display = 'block';
}
</script>
